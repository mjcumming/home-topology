# Cursor AI Rules for home-topology Project

> These rules guide AI behavior when working on this project.
> This file is automatically loaded by Cursor AI in every conversation.

---

## 1. Project Identity

- **Name**: home-topology
- **Package**: home_topology (Python import)
- **Purpose**: Platform-agnostic home topology kernel with pluggable modules
- **Python**: 3.11+ (uses `str | None` syntax)
- **Status**: v0.1.0-alpha (Foundation + OccupancyModule complete)

---

## 2. Documentation Structure (When to Read What)

### üéØ Before Starting ANY Task
**Read**: `WORK-TRACKING.md`
- Check what's already in progress
- Avoid duplicate work
- Update status as you work

### üèóÔ∏è For Architecture Decisions
**Read**: `DESIGN.md` (kernel architecture)
**Then**: Check `ADR-LOG.md` for prior decisions
**If new decision**: Add to `ADR-LOG.md` with rationale

### üì¶ For Module Implementation
**Read**: 
- `docs/modules/occupancy-design.md` (if working on occupancy)
- `docs/modules/actions-design.md` (if working on actions)

### üíª For Coding Style
**Read**: `CODING-STANDARDS.md`
- File naming, type hints, docstrings
- Architecture patterns
- Testing standards

### ‚ùì When Unsure
**Read**: `docs/open-questions.md`
- Check if question already exists
- If not, ADD it with priority level

### ü§ù For Contribution Workflow
**Read**: `CONTRIBUTING.md`

---

## 3. Core Architectural Rules (Don't Read Docs, Just Follow)

### Separation of Concerns
- `LocationManager`: Topology + config storage ONLY
- `Modules`: Behavior + runtime state ONLY
- `EventBus`: Event routing ONLY

### Module Requirements
Every module MUST implement:
- `id: str` property
- `CURRENT_CONFIG_VERSION: int` property
- `attach(bus, loc_manager)` method
- `default_config()` method
- `location_config_schema()` method
- Optional: `dump_state()`, `restore_state()`, `migrate_config()`

### Event Model
```python
Event(
    type: str,              # "sensor.state_changed", "occupancy.changed"
    source: str,            # "ha", "occupancy", "actions"
    location_id: Optional[str],
    entity_id: Optional[str],
    payload: Dict[str, Any],
    timestamp: datetime,    # UTC, use datetime.now(UTC)
)
```

### No Platform Dependencies
- NEVER import `homeassistant.*` in `src/home_topology/`
- HA integration is separate adapter (future)

---

## 4. Coding Standards (Quick Reference)

### File Naming
- Directories: lowercase, no underscores (except `src/home_topology/`)
- Python modules: `snake_case.py`
- Tests: `test_*.py`

### Code Style
- Formatter: `black` (line length 100)
- Linter: `ruff`
- Type checker: `mypy` (strict mode)
- All public functions MUST have type hints and docstrings

### Testing
- Target: >90% coverage for core, >80% for modules
- Use pytest fixtures for setup
- AAA pattern (Arrange, Act, Assert)

---

## 5. Workflow Rules

### Starting Work
1. Read `WORK-TRACKING.md` first
2. Move task to "In Progress"
3. Create feature branch
4. Read relevant module design doc

### Making Changes
1. Code + tests together (test coverage must not decrease)
2. Update docs in same commit
3. Run `make check` before committing

### Big Decisions
1. Check `ADR-LOG.md` - already decided?
2. If new: Add to `ADR-LOG.md` with context + rationale
3. Update `WORK-TRACKING.md` decision log section

### Finishing Work
1. Tests pass (`make test`)
2. Linting passes (`make check`)
3. Docs updated
4. Move task to "Completed" in `WORK-TRACKING.md`
5. Create PR with description

---

## 6. When to Read Full Documents

### Read DESIGN.md When:
- Working on kernel components (Location, EventBus, LocationManager)
- Need to understand event flow
- Designing new core features
- **Skip**: If working on module implementation details

### Read Module Design Docs When:
- Implementing or modifying a specific module
- Need signal handling details (occupancy)
- Need rule engine details (actions)
- **Skip**: If working on core kernel

### Read CODING-STANDARDS.md When:
- Unsure about naming conventions
- Need architecture pattern examples
- Writing tests
- **Skip**: If you already know the style

### Read WORK-TRACKING.md:
- **ALWAYS** at start of session
- **ALWAYS** when starting/finishing tasks
- **ALWAYS** when blocked

### Read ADR-LOG.md When:
- Making architectural decisions
- Wondering "why did we do it this way?"
- **Skip**: For day-to-day coding

### Read docs/open-questions.md When:
- Have a question that needs team input
- Before asking user a question (might be answered)
- **Skip**: If task is straightforward

---

## 7. Smart Document Loading Strategy

### Instead of Reading Everything:
```python
# ‚ùå DON'T DO THIS
read_file("DESIGN.md")
read_file("CODING-STANDARDS.md") 
read_file("WORK-TRACKING.md")
read_file("docs/modules/occupancy-design.md")
# ... spam all docs

# ‚úÖ DO THIS
# Task: "Add timeout tests for occupancy"
read_file("WORK-TRACKING.md")  # Check status
read_file("docs/modules/occupancy-design.md")  # Get implementation details
# That's it! Other rules are in this .cursorrules file
```

### Use grep/codebase_search:
```python
# Looking for how EventBus is used?
grep("EventBus", path="src/")

# Looking for occupancy timeout logic?
codebase_search("how are occupancy timeouts calculated", ["src/home_topology/modules/occupancy"])
```

---

## 8. Quick Decision Tree

```
Am I working on kernel core (Location, EventBus, Manager)?
‚îú‚îÄ YES ‚Üí Read DESIGN.md
‚îî‚îÄ NO
    ‚îÇ
    Am I implementing a module?
    ‚îú‚îÄ YES ‚Üí Read docs/modules/{module}-design.md
    ‚îî‚îÄ NO
        ‚îÇ
        Am I making an architectural decision?
        ‚îú‚îÄ YES ‚Üí Read ADR-LOG.md, then add new entry
        ‚îî‚îÄ NO
            ‚îÇ
            Do I have a question?
            ‚îú‚îÄ YES ‚Üí Read DISCUSSION-NEEDED.md, check if answered
            ‚îî‚îÄ NO ‚Üí Check WORK-TRACKING.md and code!
```

---

## 9. Anti-Patterns to Avoid

### ‚ùå Don't:
- Read all docs at start of every conversation
- Ignore WORK-TRACKING.md (leads to duplicate work)
- Make big decisions without logging in ADR-LOG.md
- Create new patterns without checking CODING-STANDARDS.md
- Forget to update docs when changing code

### ‚úÖ Do:
- Read only what's needed for current task
- Always update WORK-TRACKING.md
- Log decisions immediately
- Update docs in same commit as code
- Use grep/search before reading entire files

---

## 10. Example Scenarios

### Scenario: "Add motion sensor support to occupancy"
```
1. Read WORK-TRACKING.md (check if already in progress)
2. Read docs/modules/occupancy-design.md (understand signals)
3. grep("motion", path="src/home_topology/modules/occupancy/")
4. Code + test
5. Update WORK-TRACKING.md
```
**Don't need**: DESIGN.md, CODING-STANDARDS.md (covered by .cursorrules)

### Scenario: "Design new EnergyModule"
```
1. Read DESIGN.md (understand module architecture)
2. Read docs/modules/occupancy-design.md (example module)
3. Check ADR-LOG.md (prior module decisions)
4. Create docs/modules/energy-design.md
5. Add to WORK-TRACKING.md as planned
```

### Scenario: "Fix a bug"
```
1. Read WORK-TRACKING.md (log the bug)
2. grep the error or use codebase_search
3. Fix + test
4. Update WORK-TRACKING.md (completed)
```
**Don't need**: Design docs unless bug is architectural

---

## 11. Commit Message Format

```
<type>(<scope>): <subject>

<body>

Updated WORK-TRACKING.md: [task moved to completed]
```

Types: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`

---

## 12. Testing Requirements

- All new code MUST have tests
- Test coverage MUST NOT decrease
- Run `make check` before every commit
- Pytest fixtures in `tests/` for common setup

---

## 13. Project-Specific Conventions

### Entity Naming for Auto-Detection
- Motion: `binary_sensor.*_motion` or `binary_sensor.pir_*`
- Presence: `binary_sensor.*_presence`, `ble_*`, `*_radar`
- Doors: `binary_sensor.*_door`
- Media: `media_player.*`

### Timeout Units
- Engine internally: **minutes**
- Module config: **seconds**
- Convert at module boundary

### Import Order
```python
# 1. Standard library
import os
from datetime import datetime

# 2. Third-party (if any - avoid in core!)

# 3. Local imports
from home_topology.core import Location
from home_topology.modules.base import LocationModule
```

---

## 14. When to Ask User vs Decide

### Ask User When:
- Breaking changes to API
- New external dependencies
- Architectural direction unclear
- Multiple valid options with trade-offs

### Decide and Log When:
- Implementation details
- Code organization
- Small refactors
- Bug fixes
- Test strategies

---

## 15. Performance Guidelines

- Synchronous EventBus is fine for <100 events/sec
- Hierarchy queries are O(depth), acceptable for <10 levels
- State in memory, persist via dump_state()
- Profile only if actual performance issue

---

## 16. Summary: The Golden Rules

1. **ALWAYS read WORK-TRACKING.md first**
2. **Log architectural decisions in ADR-LOG.md**
3. **Update docs with code, not after**
4. **Don't read docs you don't need**
5. **Use grep/search before reading full files**
6. **Test everything, maintain coverage**
7. **Type hints + docstrings = mandatory**
8. **No HA dependencies in core**
9. **ALWAYS use 2025 for current dates (NOT 2024!)** ‚ö†Ô∏è

---

## Quick Reference

| Task | Read |
|------|------|
| Any task | WORK-TRACKING.md |
| Kernel work | DESIGN.md |
| Module work | docs/modules/{module}-design.md |
| Big decision | ADR-LOG.md |
| Question | docs/open-questions.md |
| Code style | This file (don't read CODING-STANDARDS) |

---

**This file is your compass. Follow it, and you won't get lost in the docs.**

Last Updated: 2025-11-24
